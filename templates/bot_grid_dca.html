{% extends "base.html" %}

{% block title %}{{ t.details }} - Grid DCA{% endblock %}

{% block css %}
    <link href="{{ url_for('static', filename='css/bot_detail.css') }}" rel="stylesheet">
{% endblock %}

{% block chart_lib %}
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
{% endblock %}

{% block js_vars %}
    <script>
        const CURRENT_BOT_ID = {{ bot_id }};
    </script>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px;">
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card p-3 d-flex flex-row justify-content-between align-items-center shadow-sm">
                <div class="d-flex align-items-center">
                    {% if bot.mode == 'replay' %}
                        <a href="/?mode=replay" id="back-to-dashboard" class="btn btn-outline-secondary btn-sm me-3">‚Üê {{ t.back }}</a>
                    {% else %}
                        <a href="/" id="back-to-dashboard" class="btn btn-outline-secondary btn-sm me-3">‚Üê {{ t.back }}</a>
                    {% endif %}
                    <div>
                        <h4 class="m-0 fw-bold">
                            <span id="bot-name-display">{{ t.loading }}</span>
                            <span class="badge bg-primary ms-2" style="font-size: 0.6em; vertical-align: middle;">üî¢ <span id="strat-name">{{ t.grid_dca }}</span></span>
                            <span class="badge bg-secondary ms-1" id="symbol-display" style="font-size: 0.6em; vertical-align: middle;">...</span>
                        </h4>
                        <span id="status-msg" class="small text-muted">{{ t.connecting }}</span>
                    </div>
                </div>
                <div class="text-end">
                    <h3 class="m-0 fw-bold text-warning" id="market-price">---</h3>
                    <small class="text-muted">{{ t.market_price }}</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2 align-items-center">
                        <span class="text-muted">{{ t.balance }}</span>
                        <div class="d-flex align-items-center">
                            <span id="balance" class="fw-bold fs-5 me-2">---</span>
                            <button class="btn btn-sm btn-outline-success py-0 px-2" data-bs-toggle="modal" data-bs-target="#depositModal" title="{{ t.deposit_increase_capital }}">
                                +
                            </button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">{{ t.realized_profit }}</span>
                        <span id="daily-profit" class="fw-bold">---</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">{{ t.net_pnl }}</span>
                        <span id="total-net-pnl" class="fw-bold">---</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">{{ t.total_fees }}</span>
                        <span id="total-fees" class="fw-bold text-danger">---</span>
                    </div>
                    <div class="d-grid gap-2">
                        <div id="live-controls" class="{% if bot.mode == 'replay' %}d-none{% endif %}">
                            <button id="btn-start" class="btn btn-success w-100" onclick="toggleBot('start')">{{ t.start_bot }}</button>
                            <button id="btn-stop" class="btn btn-danger w-100 d-none" onclick="toggleBot('stop')">{{ t.stop_bot }}</button>
                        </div>

                        <div id="replay-controls" class="{% if bot.mode != 'replay' %}d-none{% endif %}">
                            <div class="mb-2">
                                <label class="form-label small text-warning">{{ t.upload_history_csv }}</label>
                                <input class="form-control form-control-sm bg-dark text-light" type="file" id="backtest-file" accept=".csv">
                            </div>
                            <button id="btn-run-backtest" class="btn btn-warning w-100 text-dark fw-bold" onclick="runBacktest()">
                                {{ t.run_backtest }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-dark bg-gradient py-2"><small>‚öôÔ∏è {{ t.bot_params }}</small></div>
                <div class="card-body">
                    <form id="config-form">
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label">{{ t.symbol }}</label>
                                <input type="text" class="form-control form-control-sm" id="cfg-symbol" disabled>
                            </div>
                            <div class="col-6">
                                <label class="form-label">{{ t.direction }}</label>
                                <select class="form-select form-select-sm" id="cfg-direction">
                                    <option value="long">{{ t.long }}</option>
                                    <option value="short">{{ t.short }}</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-6">
                               <label class="form-label">{{ t.capital }}</label>
                                <input type="number" class="form-control form-control-sm bg-dark text-secondary" id="cfg-capital" disabled>
                            </div>
                            <div class="col-6">
                                <label class="form-label">{{ t.leverage }}</label>
                                <input type="number" class="form-control form-control-sm" id="cfg-leverage" min="1" step="1" placeholder="1">
                            </div>
                        </div>

                        <div id="manual-range-group">
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label text-danger">{{ t.range_top }}</label>
                                    <input type="number" step="any" class="form-control form-control-sm border-danger" id="cfg-range-top">
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-success">{{ t.range_bottom }}</label>
                                    <input type="number" step="any" class="form-control form-control-sm border-success" id="cfg-range-bottom">
                                </div>
                            </div>
                        </div>

                        <div id="auto-range-group" class="d-none">
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="form-label text-info">{{ t.range_percent }}</label>
                                    <input type="number" step="0.1" class="form-control form-control-sm border-info" id="cfg-range-percent" placeholder="0.2 = 20%">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">{{ t.grid_count }}</label>
                                    <input type="number" step="1" class="form-control form-control-sm" id="cfg-grid-count" placeholder="10">
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-12">
                                    <label class="form-label">{{ t.grid_distribution_type }}</label>
                                    <select class="form-select form-select-sm" id="cfg-grid-type">
                                        <option value="arithmetic">{{ t.arithmetic }}</option>
                                        <option value="geometric">{{ t.geometric }}</option>
                                    </select>
                                    <div class="form-text text-muted small" style="font-size: 0.75rem;">
                                        {{ t.grid_distribution_type_desc }}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-muted small">{{ t.current_effective_range }}</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-dark text-secondary border-secondary">{{ t.range_top }}</span>
                                    <input type="text" class="form-control bg-dark border-secondary text-secondary" id="display-range-top" readonly>
                                    <span class="input-group-text bg-dark text-secondary border-secondary">{{ t.range_bottom }}</span>
                                    <input type="text" class="form-control bg-dark border-secondary text-secondary" id="display-range-bottom" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label text-success">{{ t.tp_target }} </label>
                                <input type="number" step="0.1" class="form-control form-control-sm border-success" id="cfg-tp-target" placeholder="1.5">
                            </div>
                            <div class="col-6">
                                <label class="form-label text-danger">{{ t.sl_percent }}</label>
                                <input type="number" step="0.1" class="form-control form-control-sm border-danger" id="cfg-sl-percent" placeholder="0 (No SL)">
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                 <label class="form-label text-info">{{ t.trailing_dev }} </label>
                                 <input type="number" step="0.01" class="form-control form-control-sm border-info" id="cfg-trailing-dev" placeholder="0.2">
                            </div>
                            <div class="col-6">
                                <label class="form-label d-flex align-items-center">
                                    üßä {{ t.cooldown_seconds }}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" 
                                         class="bi bi-info-circle ms-1 text-secondary" viewBox="0 0 16 16" 
                                         style="cursor: help;" data-bs-toggle="tooltip" data-bs-html="true"
                                         title="{{ t.cooldown_seconds_desc }}">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                    </svg>
                                </label>
                                <input type="number" step="1" min="0" class="form-control form-control-sm border-secondary" id="cfg-cooldown" placeholder="60">
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label">{{ t.amount_precision }}</label>
                                <input type="number" step="0.00000001" class="form-control form-control-sm" id="cfg-amount-precision" placeholder="0.001">
                            </div>
                            <div class="col-6">
                                <label class="form-label">{{ t.market_type }}</label>
                                <select class="form-select form-select-sm" id="cfg-market-type">
                                    <option value="future">{{ t.future }}</option>
                                    <option value="spot">{{ t.spot }}</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                             <label class="form-label">{{ t.fee_rate }}</label>
                             <input type="number" step="0.0001" class="form-control form-control-sm" id="cfg-fee-rate" placeholder="0.0005">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">{{ t.close_action }}</label>
                            <select class="form-select form-select-sm" id="cfg-close-action">
                                <option value="stop">{{ t.stop_bot }}</option>
                                <option value="cooldown">üßä {{ t.cooldown_1h }}</option>
                                <option value="continue">‚ñ∂Ô∏è {{ t.continue_running }}</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2 mb-3">
                            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#rsiModal">
                                {{ t.first_order_settings }}
                            </button>
                        </div>

                        <button type="button" class="btn btn-outline-primary btn-sm w-100 mt-3" onclick="saveConfig()">üíæ {{ t.save }}</button>
                    </form>
                </div>
            </div>
            
            <div class="card-body p-2">
                <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text bg-dark border-secondary text-secondary">$</span>
                    <input type="number" id="manual-amt" class="form-control bg-black text-light border-secondary" placeholder="{{ t.manual_buy_amount }} ($)">
                    <button class="btn btn-outline-warning" onclick="manualBuy()">{{ t.manual_buy }}</button>
                </div>
                
                <button class="btn btn-danger btn-sm w-100" onclick="manualClose()">{{ t.manual_close }}</button>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-dark bg-gradient py-2 d-flex justify-content-between align-items-center">
                    <small>üìà {{ t.kline_chart }}</small>
                    <div class="d-flex align-items-center">
                        <select id="timeframe-select" class="form-select form-select-sm w-auto bg-dark text-light border-secondary me-2" style="height: 24px; padding-top: 0; padding-bottom: 0; font-size: 0.8rem;">
                            <option value="1m">{{ t.tf_1m }}</option>
                            <option value="3m">{{ t.tf_3m }}</option>
                            <option value="5m">{{ t.tf_5m }}</option>
                            <option value="15m" selected>{{ t.tf_15 }}</option>
                            <option value="1h">{{ t.tf_1h }}</option>
                            <option value="4h">{{ t.tf_4h }}</option>
                            <option value="1d">{{ t.tf_1d }}</option>
                            <option value="1w">{{ t.tf_1w }}</option>
                        </select>
                        <button class="btn btn-sm btn-outline-light d-flex align-items-center justify-content-center" 
                                style="height: 24px; width: 24px; padding: 0;" 
                                onclick="fetchHistoryKline()" 
                                title="{{ t.refresh }}">
                            ‚Üª
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="tv-chart-container" style="height: 350px; width: 100%;"></div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between bg-dark bg-gradient py-2">
                    <small>üìä {{ t.position_status }}</small>
                    <span id="pos-direction" class="badge bg-secondary">{{ t.no_position }}</span>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-4 border-end border-secondary">
                            <div class="text-muted small">{{ t.pos_avg }}</div>
                            <div class="fs-5 font-monospace" id="pos-avg">---</div>
                        </div>
                        <div class="col-4 border-end border-secondary">
                            <div class="text-muted small">{{ t.pos_amt }}</div>
                            <div class="fs-5 font-monospace" id="pos-amt">---</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">{{ t.pos_cost }}</div>
                            <div class="fs-5 font-monospace" id="pos-cost">---</div>
                        </div>
                    </div>
                    <div class="row text-center align-items-center">
                        <div class="col-6">
                            <div class="text-muted small">{{ t.floating_pnl }}</div>
                            <div class="fs-2 fw-bold" id="pos-pnl">0.00</div>
                            <div id="pos-pnl-pct" class="small">0.00%</div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted small">{{ t.current_grid_anchor }}</div>
                            <div class="fs-4 fw-bold text-info" id="grid-level-display">---</div>
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-black bg-opacity-25 rounded border border-dark d-flex justify-content-between align-items-center">
                        <span class="small">üéØ {{ t.trail_status }}: <span id="trail-status" class="fw-bold">{{ t.not_activated }}</span></span>
                        <span class="small text-muted">{{ t.trail_high }}: <span id="trail-high" class="text-light">---</span></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark bg-gradient py-2"><small>ü™ú {{ t.grid_ladder }}</small></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm table-hover m-0 text-center">
                            <thead>
                                <tr class="text-muted">
                                    <th>Level</th>
                                    <th>{{ t.price }}</th>
                                    <th>{{ t.current_order_usdt }}</th>
                                    <th>{{ t.drawdown_percent }}</th>
                                    <th>{{ t.status }}</th>
                                </tr>
                            </thead>
                            <tbody id="ladder-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-header bg-dark p-0">
                    <ul class="nav nav-tabs border-bottom-0" id="logTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-0 text-light py-2" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button">
                                {{ t.history_tab }}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-0 text-secondary py-2" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-pane" type="button">
                                {{ t.logs_tab }}
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0 bg-black tab-content">
                    <div class="tab-pane fade show active h-100" id="history-pane" role="tabpanel">
                        <div id="rounds-container" class="log-box h-100 p-0" style="overflow-y: auto;">
                            <div class="text-center text-muted mt-4">{{ t.loading }}</div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade h-100" id="logs-pane" role="tabpanel">
                        <div id="logs-container" class="log-box h-100 p-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include "partials/bot_modals.html" %}

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/bot_common.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bot_grid_dca.js') }}"></script>
{% endblock %}